# ChittyVerify ChittyCert Integration - Deployment Checklist

**Status:** ‚úÖ CODE COMPLETE - READY FOR DEPLOYMENT
**Date:** 2025-11-09
**Location:** `/Users/nb/Projects/development/chittyfoundation/chittyverify/`

---

## üéØ Pre-Deployment Verification

### Code Status
- [x] All TypeScript code implemented
- [x] Build successful (dist/ artifacts created)
- [x] Schema validated (8.5/10 - APPROVED)
- [x] TIMESTAMPTZ fix applied (critical)
- [x] ChittyCert API endpoints corrected
- [x] Documentation complete

### Files Created/Modified
**New Files:** 11
- `server/chittycert-service.ts` (13.8 KB)
- `src/lib/chittytrust-client.ts` (8.9 KB)
- `client/src/components/verification/*` (3 files)
- `migrations/001_add_signature_fields_v2.sql` (2.9 KB)
- Documentation (4 MD files)

**Modified Files:** 4
- `shared/schema.ts` - Added signature fields
- `server/storage.ts` - Added signing methods
- `server/routes.ts` - Added 3 API endpoints
- `CLAUDE.md` - Updated structure

---

## üöÄ Deployment Steps

### Step 1: Environment Configuration ‚è≥
```bash
cd /Users/nb/Projects/development/chittyfoundation/chittyverify

# Create .env file
cp .env.template .env

# Edit .env and set:
nano .env
```

**Required Variables:**
```bash
DATABASE_URL=postgresql://user:pass@host:5432/chittyos-core
CHITTYCERT_URL=https://cert.chitty.cc
CHITTYCERT_SERVICE_TOKEN=<get_from_chittycert>
CHITTYVERIFY_CHITTY_ID=<get_from_chittyid>
NODE_ENV=production
PORT=5000
SESSION_SECRET=<generate_32_chars>
JWT_SECRET=<generate_32_chars>
```

**Action Items:**
- [ ] Copy .env.template to .env
- [ ] Set DATABASE_URL to Neon PostgreSQL
- [ ] Get ChittyCert service token
- [ ] Get ChittyVerify ChittyID
- [ ] Generate secure SESSION_SECRET (32+ chars)
- [ ] Generate secure JWT_SECRET (32+ chars)

---

### Step 2: Database Migration ‚è≥
```bash
# Verify database connection
psql $DATABASE_URL -c "SELECT version();"

# Run migration
psql $DATABASE_URL -f migrations/001_add_signature_fields_v2.sql

# Verify migration success
psql $DATABASE_URL -c "
  SELECT column_name, data_type, is_nullable
  FROM information_schema.columns
  WHERE table_name = 'master_evidence'
    AND column_name LIKE '%signature%'
  ORDER BY ordinal_position;
"
```

**Expected Output:**
```
      column_name       |          data_type          | is_nullable
------------------------+-----------------------------+-------------
 signature              | text                        | YES
 signer_certificate_pem | text                        | YES
 signed_by_cert_serial  | text                        | YES
 signature_timestamp    | timestamp with time zone    | YES
(4 rows)
```

**Action Items:**
- [ ] Verify DATABASE_URL is set
- [ ] Test database connection
- [ ] Create backup of database (if production data exists)
- [ ] Run migration script
- [ ] Verify 4 columns created
- [ ] Verify TIMESTAMPTZ type on signature_timestamp
- [ ] Check indexes created (3 total)

---

### Step 3: ChittyCert Certificate Request ‚è≥

**Generate Key Pair:**
```bash
# Option 1: Use ChittyTrust client (automatic)
# Key pair will be generated by chittycert-service on first run

# Option 2: Manual generation (for pre-approval)
# See chittytrust-client.ts generateKeyPair() function
```

**Request Certificate:**
```bash
curl -X POST https://cert.chitty.cc/api/v1/x509/ca/issue \
  -H "Authorization: Bearer $CHITTYCERT_SERVICE_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "requestorChittyId": "'$CHITTYVERIFY_CHITTY_ID'",
    "requestorService": "chittyverify",
    "usage": "document_signing",
    "subject": {
      "commonName": "ChittyVerify Evidence Signing",
      "organization": "ChittyOS",
      "organizationalUnit": "Legal Technology",
      "country": "US"
    },
    "publicKeyPem": "<PUBLIC_KEY_FROM_GENERATED_KEYPAIR>",
    "validityYears": 2
  }'
```

**Store Certificate in .env:**
```bash
# Add to .env:
CHITTYCERT_CERTIFICATE_PEM="-----BEGIN CERTIFICATE-----
...certificate from response...
-----END CERTIFICATE-----"

CHITTYCERT_PRIVATE_KEY_PEM="-----BEGIN PRIVATE KEY-----
...private key from generation...
-----END PRIVATE KEY-----"

CHITTYCERT_PUBLIC_KEY_PEM="-----BEGIN PUBLIC KEY-----
...public key from generation...
-----END PUBLIC KEY-----"

CHITTYCERT_CERTIFICATE_SERIAL=CERT-12345678
CHITTYCERT_VALID_FROM=2025-11-09T00:00:00Z
CHITTYCERT_VALID_UNTIL=2027-11-09T00:00:00Z
```

**Action Items:**
- [ ] Request certificate from ChittyCert
- [ ] Store certificate PEM in .env
- [ ] Store private key PEM in .env (SECURE!)
- [ ] Store public key PEM in .env
- [ ] Note certificate serial number
- [ ] Note validity dates
- [ ] Verify certificate in ChittyCert dashboard

**‚ö†Ô∏è SECURITY WARNING:**
- NEVER commit .env to version control
- Store private key in secrets manager for production
- Restrict file permissions: `chmod 600 .env`

---

### Step 4: Server Initialization ‚è≥

**Initialize ChittyCert Service:**

Edit `server/index.ts` to add ChittyCert initialization:

```typescript
import { initChittyCertService } from './chittycert-service';

// Add after other imports and before app.listen()

// Initialize ChittyCert service
if (process.env.CHITTYCERT_URL &&
    process.env.CHITTYCERT_SERVICE_TOKEN &&
    process.env.CHITTYVERIFY_CHITTY_ID) {

  const certService = initChittyCertService({
    certServiceUrl: process.env.CHITTYCERT_URL,
    serviceToken: process.env.CHITTYCERT_SERVICE_TOKEN,
    chittyId: process.env.CHITTYVERIFY_CHITTY_ID
  });

  // Load certificate if available
  if (process.env.CHITTYCERT_CERTIFICATE_PEM &&
      process.env.CHITTYCERT_PRIVATE_KEY_PEM) {
    certService.loadCertificate({
      certificatePem: process.env.CHITTYCERT_CERTIFICATE_PEM,
      privateKeyPem: process.env.CHITTYCERT_PRIVATE_KEY_PEM,
      serialNumber: process.env.CHITTYCERT_CERTIFICATE_SERIAL!,
      publicKeyPem: process.env.CHITTYCERT_PUBLIC_KEY_PEM!,
      validFrom: process.env.CHITTYCERT_VALID_FROM!,
      validUntil: process.env.CHITTYCERT_VALID_UNTIL!
    });
    console.log('‚úÖ ChittyCert certificate loaded:', process.env.CHITTYCERT_CERTIFICATE_SERIAL);
  } else {
    console.warn('‚ö†Ô∏è  ChittyCert certificate not configured. Evidence signing disabled.');
  }
} else {
  console.warn('‚ö†Ô∏è  ChittyCert not configured. Set CHITTYCERT_URL, CHITTYCERT_SERVICE_TOKEN, and CHITTYVERIFY_CHITTY_ID');
}
```

**Action Items:**
- [ ] Add ChittyCert initialization to server/index.ts
- [ ] Verify environment variables are loaded
- [ ] Check console for initialization messages

---

### Step 5: Start Server ‚è≥
```bash
cd /Users/nb/Projects/development/chittyfoundation/chittyverify

# Production start
npm run start

# Or with PM2 (recommended)
pm2 start dist/index.js --name chittyverify
pm2 save
pm2 startup
```

**Action Items:**
- [ ] Start server
- [ ] Check for initialization logs
- [ ] Verify ChittyCert certificate loaded
- [ ] Note server port (default 5000)

---

### Step 6: Smoke Tests ‚è≥

**Test Health Endpoint:**
```bash
curl http://localhost:5000/health
# Expected: {"status":"ok"}
```

**Test Evidence Signing:**
```bash
# Create test evidence first (or use existing evidence ID)
TEST_EVIDENCE_ID="test-evidence-001"

# Sign evidence
curl -X POST http://localhost:5000/api/v1/evidence/$TEST_EVIDENCE_ID/sign \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $API_TOKEN"

# Expected response:
# {
#   "success": true,
#   "message": "Evidence signed successfully",
#   "data": {
#     "evidenceId": "...",
#     "signature": "base64-encoded-signature",
#     "certificateSerial": "CERT-12345678",
#     "signedAt": "2025-11-09T..."
#   }
# }
```

**Test Signature Verification:**
```bash
curl http://localhost:5000/api/v1/evidence/$TEST_EVIDENCE_ID/verify \
  -H "Authorization: Bearer $API_TOKEN"

# Expected response:
# {
#   "success": true,
#   "data": {
#     "signatureValid": true,
#     "certificateValid": true,
#     "overallValid": true,
#     "details": "Signature and certificate are valid"
#   }
# }
```

**Test Signature Info:**
```bash
curl http://localhost:5000/api/v1/evidence/$TEST_EVIDENCE_ID/signature-info \
  -H "Authorization: Bearer $API_TOKEN"

# Expected response includes:
# - signature (base64)
# - certificateSerial
# - signedAt timestamp
# - algorithm info
```

**Action Items:**
- [ ] Test health endpoint
- [ ] Create test evidence
- [ ] Test signature endpoint
- [ ] Verify signature created
- [ ] Test verification endpoint
- [ ] Verify signature validation works
- [ ] Test signature info endpoint
- [ ] Verify certificate details returned

---

### Step 7: Backward Compatibility Test ‚è≥

**Test Existing Evidence:**
```bash
# Query existing evidence (should still load)
curl http://localhost:5000/api/cases/existing-case-id/evidence \
  -H "Authorization: Bearer $API_TOKEN"

# Verify:
# - Existing evidence loads successfully
# - signature fields are NULL (expected)
# - No errors or warnings
```

**Action Items:**
- [ ] Query existing evidence
- [ ] Verify NULL signature fields accepted
- [ ] Confirm no breaking changes
- [ ] Test evidence display in UI

---

### Step 8: Production Monitoring ‚è≥

**Set Up Monitoring:**
```bash
# Monitor application logs
tail -f /var/log/chittyverify/app.log

# Or with PM2
pm2 logs chittyverify

# Watch for:
# ‚úÖ "ChittyCert certificate loaded: CERT-..."
# ‚úÖ "Evidence signed: evidence-id-..."
# ‚úÖ "Signature verified: evidence-id-..."
# ‚ö†Ô∏è  Any errors or warnings
```

**Monitor Database Performance:**
```sql
-- Check index usage
SELECT schemaname, tablename, indexname, idx_scan
FROM pg_stat_user_indexes
WHERE tablename = 'master_evidence'
  AND indexname LIKE '%signature%';

-- Should show increasing idx_scan counts
```

**Action Items:**
- [ ] Set up log monitoring
- [ ] Configure error alerts
- [ ] Monitor certificate expiration (alert 30 days before)
- [ ] Track signature success rate
- [ ] Monitor ChittyCert API availability
- [ ] Set up database performance monitoring

---

## üéØ Success Criteria

### Deployment is successful when:

1. ‚úÖ Environment configured
   - [ ] .env file created with all required variables
   - [ ] Secrets secured (not in version control)

2. ‚úÖ Database migrated
   - [ ] 4 signature columns created
   - [ ] TIMESTAMPTZ type verified
   - [ ] 3 indexes created
   - [ ] Migration validation passed

3. ‚úÖ Certificate obtained
   - [ ] ChittyCert certificate requested
   - [ ] Certificate stored in .env
   - [ ] Private key secured

4. ‚úÖ Server running
   - [ ] Server started without errors
   - [ ] ChittyCert certificate loaded
   - [ ] API endpoints accessible

5. ‚úÖ Functionality verified
   - [ ] Evidence can be signed
   - [ ] Signatures can be verified
   - [ ] Signature info retrievable
   - [ ] Existing evidence still works

6. ‚úÖ Monitoring configured
   - [ ] Logs being collected
   - [ ] Alerts configured
   - [ ] Performance metrics tracked

---

## üîÑ Rollback Plan

### If deployment fails:

```bash
# Stop server
pm2 stop chittyverify

# Rollback database
psql $DATABASE_URL <<'SQL'
BEGIN;
DROP INDEX IF EXISTS idx_master_evidence_cert_serial;
DROP INDEX IF EXISTS idx_master_evidence_signature_timestamp;
DROP INDEX IF EXISTS idx_master_evidence_signing_audit;
ALTER TABLE master_evidence
  DROP COLUMN IF EXISTS signature,
  DROP COLUMN IF EXISTS signer_certificate_pem,
  DROP COLUMN IF EXISTS signed_by_cert_serial,
  DROP COLUMN IF EXISTS signature_timestamp;
COMMIT;
SQL

# Revert code
git checkout HEAD~1
npm run build
pm2 start chittyverify
```

**Rollback Time:** < 5 minutes

---

## üìä Post-Deployment

### Week 1 Monitoring
- [ ] Monitor error rates (target: < 1%)
- [ ] Track signature success rate (target: > 95%)
- [ ] Verify OCSP checks working
- [ ] Check certificate chain validation
- [ ] Monitor performance impact (should be minimal)

### Certificate Management
- [ ] Set calendar reminder for certificate renewal (30 days before expiration)
- [ ] Document certificate renewal process
- [ ] Test certificate rotation procedure

### Documentation Updates
- [ ] Update API documentation with new endpoints
- [ ] Add signature examples to user guide
- [ ] Document troubleshooting procedures

---

## üìû Support Resources

### Documentation
- `DEPLOYMENT_GUIDE.md` - Detailed deployment guide
- `DEPLOYMENT_READY.md` - Executive summary
- `CHITTYCERT_INTEGRATION.md` - Integration details
- `CHITTYCERT_API_UPDATE.md` - API reference

### External Services
- ChittyCert API: https://cert.chitty.cc/api/docs
- ChittyTrust PKI: /chittyfoundation/chittytrust
- ChittyID Service: https://id.chitty.cc

### Emergency Contacts
- ChittyCert Support: (configure alert endpoint)
- Database Issues: (Neon support)
- ChittyOS Team: (internal escalation)

---

## ‚úÖ Sign-Off

**Deployment Completed By:** _________________

**Date:** _________________

**Environment:** [ ] Staging [ ] Production

**All Checklist Items Completed:** [ ] Yes [ ] No

**Issues Encountered:** _________________

**Resolution:** _________________

**Notes:** _________________

---

**üöÄ Deployment ready! Follow this checklist step by step.**
